
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>showTrapsInteractively</title><meta name="generator" content="MATLAB 7.13"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2013-02-08"><meta name="DC.source" content="showTrapsInteractively.m"><style type="text/css">

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#1">Interactive spill point analysis of top surface grids</a></li><li><a href="#2">Explore a synthetic grid</a></li><li><a href="#3">Show interactive plot</a></li><li><a href="#4">Interact with a more interesting dataset</a></li><li><a href="#5">Grid from the IGEMS (Impact of Realistic Geologic Models on Simulation of CO2 storage) project</a></li><li><a href="#6">Activate trapping</a></li></ul></div><h2>Interactive spill point analysis of top surface grids<a name="1"></a></h2><p>This example demonstrates the use of the interactive viewer for viewing and finding structural traps for CO2 migration. This tutorial is primarily concerned with interactive usage: For general information of trap analysis, see the showTrappingStructure example.</p><p>Select trapping algorithm</p><pre class="codeinput">useCell = true;

<span class="keyword">switch</span> useCell
    <span class="keyword">case</span> true
        method = <span class="string">'cell'</span>;
    <span class="keyword">otherwise</span>
        method = <span class="string">'node'</span>;
<span class="keyword">end</span>

<span class="comment">% Check if the script is run interactively</span>
isInteractive = numel(dbstack) == 0;
</pre><h2>Explore a synthetic grid<a name="2"></a></h2><p>We first create a simple synthetic grid to demonstrate the interactive trapping. This grid is created by producing a simple Cartesian geometry and perturbing the z coordinates by a periodic function based on x and y to get several local traps. Additionally, to create a hierachy of traps, we slant the grid.</p><pre class="codeinput">L = 1000; L_p = L/5; H = 10;
G = cartGrid([101 101 1],[L L H]);


<span class="comment">% Set new coordinates, compute geometry information</span>
G.nodes.coords(:,3) =   100 + G.nodes.coords(:,3) + <span class="keyword">...</span>
                              G.nodes.coords(:,1)*0.01<span class="keyword">...</span>
                    -2*sin(pi*G.nodes.coords(:,1)/L_p).*<span class="keyword">...</span>
                       sin(pi*G.nodes.coords(:,2)/L_p);

G = computeGeometry(G);

<span class="comment">% Create top surface grid</span>
Gt = topSurfaceGrid(G);
</pre><h2>Show interactive plot<a name="3"></a></h2><p>We plot the top surface grid in the interactive viewer. Initially the possible structural traps are shown, colorized by the volume of each structural trap on a white grid.</p><p>The following functionality is present:</p><p>- Left clicking on a trap will colorize the trap and all other traps that   are downstream to that trap along with the path between them. Left   clicking shows an estimate of where and how any slowly injected CO2   will migrate from the click position. When left-clicking, two   additional plots are produced:</p><pre>  * The upper figure is a pie chart showing the approximate volumes
    of both the clicked trap (direct volume) and the volume of traps
    along the migration path (migration volume) as well as the volume of
    the traps which are not on the migration path. By exploring the grid
    interactively, one can try to find the best possible injection site
    for a top surface grid with regards to long term migration.</pre><pre>  * The second figure shows a logarithmic bar chart of the trap volumes
    along with their position along the migration path. This is useful
    for several reasons; One being that the quality of the dataset may
    impact the correctness of far away traps, another being that far
    away traps will likely meet a slower CO2 front, making the model of
    infinitesimally slow migration better.</pre><p>- Right or ctrl-clicking on a trap will open a new plot showing the trap   in detail along with the region around it. The largest possible   structural trapping volume for the region will be indicated in red and   blue.</p><p>- Middle mouse or shift-clicking on a trap will show all traps that are   upstream to the current trap much in the same manner as left mouse   click. This can be used to find possible injection sites which will   migrate over time to a large reservoir volume.</p><p>- The toolbar in the figure window has several functions:</p><pre>  * Toggle display of unselected traps.</pre><pre>  * Toggle display of spill regions. Spill regions determine which trap
    gas injected in an area will migrate to. Regions which spill out of
    the grid are marked in blue.</pre><pre>  * Toggle lighting. Lighting can be computationally intensive in
    MATLAB, but makes it easier to see local changes in topology.</pre><pre>  * Toggle contour lines. Only available when plotting atlas grids.</pre><pre>  * Reset view. The selection algorithm works best from a top down
    view.</pre><pre>  * Setup VE simulation. The currently clicked cell will become an
    injector in a vertically averaged CO2 migration simulation. The user
    can setup injection rates and timesteps through a simple user
    interface and stop simulations by closing the visualization
    window.</pre><pre class="codeinput">h = interactiveTrapping(Gt, <span class="string">'method'</span>, method, <span class="string">'light'</span>, true);
view(180, 50)

disp(<span class="string">'Showing synthetic dataset... Close to continue'</span>)
<span class="keyword">if</span> isInteractive
    waitfor(h)
<span class="keyword">end</span>
</pre><pre class="codeoutput">Trap level 1: 13 traps identified
Start find rivers
Showing synthetic dataset... Close to continue
</pre><img vspace="5" hspace="5" src="showTrapsInteractively_01.png" alt=""> <h2>Interact with a more interesting dataset<a name="4"></a></h2><p>By passing in the name of a CO2 Storage Atlas grid, the function automatically generates the grid for us. We select the Johansen formation and apply some coarsening to make the grid smaller. Note that full resolution should be used if possible to get the best accuracy.</p><pre class="codeinput">h = interactiveTrapping(<span class="string">'Johansenfm'</span>, <span class="string">'coarsening'</span>, 2, <span class="string">'method'</span>, method);
view(-70, 80)

disp(<span class="string">'Showing CO2 Atlas dataset... Close to continue'</span>)
<span class="keyword">if</span> isInteractive
    waitfor(h)
<span class="keyword">end</span>
</pre><pre class="codeoutput">Trap level 1: 327 traps identified
Trap level 2: 54 traps identified
Trap level 3: 11 traps identified
Trap level 4: 2 traps identified
Warning: purging 34 bad traps with 0 spill value.
Start find rivers
Showing CO2 Atlas dataset... Close to continue
</pre><img vspace="5" hspace="5" src="showTrapsInteractively_02.png" alt=""> <h2>Grid from the IGEMS (Impact of Realistic Geologic Models on Simulation of CO2 storage) project<a name="5"></a></h2><p>We read and process a grid from the folder data/igems/eclipsegrids. These grids are very large, so this part of the example requires C-accelerated geometry computation. For more information, see the IGEMS website at <a href="http://www.nr.no/nb/IGEMS">http://www.nr.no/nb/IGEMS</a>.</p><pre class="codeinput">require <span class="string">mex</span>

G = readIGEMSIRAP(<span class="string">'OSS'</span>, 1, <span class="string">'coarse'</span>, [2 2]);
Gt = topSurfaceGrid(G);
</pre><h2>Activate trapping<a name="6"></a></h2><pre class="codeinput">h = interactiveTrapping(Gt, <span class="string">'method'</span>, method);
view(180, 50)

disp(<span class="string">'Showing IGEMS dataset... Close to continue'</span>)
<span class="keyword">if</span> isInteractive
    waitfor(h)
<span class="keyword">end</span>
</pre><pre class="codeoutput">Trap level 1: 61 traps identified
Trap level 2: 12 traps identified
Trap level 3: 1 traps identified
Start find rivers
Showing IGEMS dataset... Close to continue
</pre><img vspace="5" hspace="5" src="showTrapsInteractively_03.png" alt=""> <p class="footer"><br>
      Published with MATLAB&reg; 7.13<br></p></div><!--
##### SOURCE BEGIN #####
%% Interactive spill point analysis of top surface grids
% This example demonstrates the use of the interactive viewer for viewing
% and finding structural traps for CO2 migration. This tutorial is
% primarily concerned with interactive usage: For general information of
% trap analysis, see the showTrappingStructure example.
%
% Select trapping algorithm
useCell = true;

switch useCell
    case true
        method = 'cell';
    otherwise
        method = 'node';
end

% Check if the script is run interactively
isInteractive = numel(dbstack) == 0;
%% Explore a synthetic grid
% We first create a simple synthetic grid to demonstrate the interactive
% trapping. This grid is created by producing a simple Cartesian geometry
% and perturbing the z coordinates by a periodic function based on x and y
% to get several local traps. Additionally, to create a hierachy of traps,
% we slant the grid.

L = 1000; L_p = L/5; H = 10;
G = cartGrid([101 101 1],[L L H]);


% Set new coordinates, compute geometry information
G.nodes.coords(:,3) =   100 + G.nodes.coords(:,3) + ...
                              G.nodes.coords(:,1)*0.01...
                    -2*sin(pi*G.nodes.coords(:,1)/L_p).*...
                       sin(pi*G.nodes.coords(:,2)/L_p);
                   
G = computeGeometry(G);

% Create top surface grid
Gt = topSurfaceGrid(G);

%% Show interactive plot
% We plot the top surface grid in the interactive viewer. Initially the
% possible structural traps are shown, colorized by the volume of each
% structural trap on a white grid.
% 
% The following functionality is present:
%
% - Left clicking on a trap will colorize the trap and all other traps that
%   are downstream to that trap along with the path between them. Left
%   clicking shows an estimate of where and how any slowly injected CO2
%   will migrate from the click position. When left-clicking, two
%   additional plots are produced:
%
%    * The upper figure is a pie chart showing the approximate volumes
%      of both the clicked trap (direct volume) and the volume of traps
%      along the migration path (migration volume) as well as the volume of
%      the traps which are not on the migration path. By exploring the grid
%      interactively, one can try to find the best possible injection site
%      for a top surface grid with regards to long term migration.
%
%    * The second figure shows a logarithmic bar chart of the trap volumes
%      along with their position along the migration path. This is useful
%      for several reasons; One being that the quality of the dataset may
%      impact the correctness of far away traps, another being that far
%      away traps will likely meet a slower CO2 front, making the model of
%      infinitesimally slow migration better.
%
% - Right or ctrl-clicking on a trap will open a new plot showing the trap
%   in detail along with the region around it. The largest possible
%   structural trapping volume for the region will be indicated in red and
%   blue.
%
% - Middle mouse or shift-clicking on a trap will show all traps that are
%   upstream to the current trap much in the same manner as left mouse
%   click. This can be used to find possible injection sites which will
%   migrate over time to a large reservoir volume.
%
% - The toolbar in the figure window has several functions:
%
%    * Toggle display of unselected traps.
%
%    * Toggle display of spill regions. Spill regions determine which trap
%      gas injected in an area will migrate to. Regions which spill out of
%      the grid are marked in blue.
%
%    * Toggle lighting. Lighting can be computationally intensive in
%      MATLAB, but makes it easier to see local changes in topology.
% 
%    * Toggle contour lines. Only available when plotting atlas grids.
%
%    * Reset view. The selection algorithm works best from a top down
%      view.
%
%    * Setup VE simulation. The currently clicked cell will become an
%      injector in a vertically averaged CO2 migration simulation. The user
%      can setup injection rates and timesteps through a simple user
%      interface and stop simulations by closing the visualization
%      window.
%

h = interactiveTrapping(Gt, 'method', method, 'light', true);
view(180, 50)

disp('Showing synthetic dataset... Close to continue')
if isInteractive
    waitfor(h)
end
%% Interact with a more interesting dataset
% By passing in the name of a CO2 Storage Atlas grid, the function
% automatically generates the grid for us. We select the Johansen formation
% and apply some coarsening to make the grid smaller. Note that full
% resolution should be used if possible to get the best accuracy.

h = interactiveTrapping('Johansenfm', 'coarsening', 2, 'method', method);
view(-70, 80)

disp('Showing CO2 Atlas dataset... Close to continue')
if isInteractive
    waitfor(h)
end
%% Grid from the IGEMS (Impact of Realistic Geologic Models on Simulation of CO2 storage) project
% We read and process a grid from the folder data/igems/eclipsegrids. These
% grids are very large, so this part of the example requires C-accelerated
% geometry computation. For more information, see the IGEMS website at
% http://www.nr.no/nb/IGEMS.

require mex

G = readIGEMSIRAP('OSS', 1, 'coarse', [2 2]);
Gt = topSurfaceGrid(G);

%% Activate trapping
h = interactiveTrapping(Gt, 'method', method);
view(180, 50)

disp('Showing IGEMS dataset... Close to continue')
if isInteractive
    waitfor(h)
end

##### SOURCE END #####
--></body></html>