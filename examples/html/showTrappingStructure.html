
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Investigation of Structural Trapping</title><meta name="generator" content="MATLAB 7.13"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2013-02-08"><meta name="DC.source" content="showTrappingStructure.m"><style type="text/css">

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head><body><div class="content"><h1>Investigation of Structural Trapping</h1><!--introduction--><p>The purpose of the example is to demonstrate some of the functionality we have available for studying migration patterns and finding structural trapping. As an example, we consider the Utsira formation for which we will trace gravity lines, identify structural traps, and investigate how they are connected.</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Load data</a></li><li><a href="#2">Trace gravity lines on the top surface</a></li><li><a href="#3">Find trapping structure</a></li><li><a href="#7">Find trap connections (river system)</a></li></ul></div><h2>Load data<a name="1"></a></h2><p>Make top-surface grid from a coarsened version of the Utsira formation</p><pre class="codeinput">[grdecl,m] = getAtlasGrid(<span class="string">'Utsirafm'</span>,<span class="string">'coarsening'</span>,3);
G    = processGRDECL(grdecl{1});
Gt   = topSurfaceGrid(G(1));
meta = m{2}.meta;
data = abs(m{2}.data)';
data(data==0) = NaN;
</pre><h2>Trace gravity lines on the top surface<a name="2"></a></h2><p>To show the potential migration paths, we trace 'gravity' lines in the upward direction using a flux defined on a standard TPFA type connection</p><pre class="codeinput"><span class="comment">% Define flux</span>
internal = all(Gt.faces.neighbors&gt;0,2);
n1   = Gt.faces.neighbors(internal,1);
n2   = Gt.faces.neighbors(internal,2);
flux = zeros(Gt.faces.num,1);
flux(internal)= Gt.cells.z(n2) - Gt.cells.z(n1);
state = struct(<span class="string">'flux'</span>,flux);
clear <span class="string">internal</span> <span class="string">n1</span> <span class="string">n2</span> <span class="string">flux</span>;

<span class="comment">% Pick approximately five hundred cells and trace streamlines backward</span>
<span class="comment">% using the Pollock routine from MRST's streamlines module</span>
mrstModule <span class="string">add</span> <span class="string">streamlines</span>
seeds = (1:ceil(Gt.cells.num/500):Gt.cells.num)';
S = pollock(Gt, state, [seeds, repmat([.5,.5],numel(seeds),1)], <span class="string">'reverse'</span>, true);

<span class="comment">% Make Cartesian grid for fast interpolation to surface</span>
y = linspace(0,meta.cellsize*(meta.ncols-1),meta.ncols) + meta.yllcorner;
x = linspace(0,meta.cellsize*(meta.nrows-1),meta.nrows) + meta.xllcorner;
[X,Y] = meshgrid(x,y); clear <span class="string">x</span> <span class="string">y</span>;

<span class="comment">% Collect streamlines in a long array separated by zeros and calculate the</span>
<span class="comment">% corresponding z-value by interpolating in the original meta data set.</span>
<span class="comment">% Afterwards, replace zeros by NaN's for use in plotting.</span>
c = zeros(sum([cellfun(@length,S); numel(S)]),3);
i = 1;
<span class="keyword">for</span> k=1:numel(S)
   nsl = length(S{k});
   c(i:i+nsl-1,1:2) = S{k};
   i = i+nsl+1;
<span class="keyword">end</span>
c(:,3) = interp2(X,Y,data, c(:,1), c(:,2));
c(c==0)=NaN;

<span class="comment">% Use the original meta data to surf make the surface, but offset the plots</span>
<span class="comment">% slightly to distinguish the surface and the gravity lines</span>
figure(1),clf
surf(X,Y,data+1),shading <span class="string">interp</span>
hold <span class="string">on</span>
plot3(c(:,1),c(:,2),c(:,3)-1, <span class="string">'k-'</span>, <span class="string">'LineWidth'</span>, 1);
hold <span class="string">off</span>
view(70,50), axis <span class="string">tight</span>, set(gca,<span class="string">'ZDir'</span>,<span class="string">'reverse'</span>);
</pre><img vspace="5" hspace="5" src="showTrappingStructure_01.png" alt=""> <h2>Find trapping structure<a name="3"></a></h2><p>We find all traps corresponding to local maxima on the top surface. The traps are categorized as different levels. A level-1 trap contains one local maximum point; a level-2 trap contains at least two level-1 traps and hence at least one spill point; a level-3 trap contains at least two level-2 traps; and so on. As part of finding the trapping structure, we construct a new top-surface grid for which the topography inside the level-1 traps have been replaced by a flat surface at the depth of the corresponding spill point.</p><pre class="codeinput"><span class="comment">% Check for existence of the MATLAB graph library</span>
checkBGL();

ts=findTrappingStructure(Gt);

<span class="comment">% Plot the new top-surface grid on top of the old one to show the location</span>
<span class="comment">% of traps</span>
clf, subplot(<span class="string">'position'</span>,[.025 .025 .95 .95]);
plotGrid(Gt,      <span class="string">'FaceColor'</span>,<span class="string">'r'</span>,<span class="string">'EdgeAlpha'</span>,.1)
plotGrid(ts.Gtop, <span class="string">'FaceColor'</span>,<span class="string">'y'</span>,<span class="string">'EdgeColor'</span>,<span class="string">'none'</span>);
view(92,40), axis <span class="string">tight</span> <span class="string">off</span>, set(gca,<span class="string">'ZDir'</span>,<span class="string">'reverse'</span>);
</pre><pre class="codeoutput">Trap level 1: 102 traps identified
Trap level 2: 13 traps identified
Trap level 3: 1 traps identified
</pre><img vspace="5" hspace="5" src="showTrappingStructure_02.png" alt=""> <p>Show the flat parts of the grid</p><pre class="codeinput">cla
plotGrid(ts.Gtop,<span class="string">'FaceColor'</span>,<span class="string">'none'</span>,<span class="string">'EdgeAlpha'</span>,.1)
plotGrid(ts.Gtop, ts.z_spill_loc&gt;0, <span class="string">'EdgeAlpha'</span>, .1)
</pre><img vspace="5" hspace="5" src="showTrappingStructure_03.png" alt=""> <p>Show the traps on different levels in different colors</p><pre class="codeinput">cla
plotGrid(ts.Gtop,<span class="string">'FaceColor'</span>,<span class="string">'none'</span>,<span class="string">'edgeAlpha'</span>,0.1)
nt  = numel(ts.trap_level);
col = hsv(nt);
<span class="keyword">for</span> k=nt:-1:1
   cell_list = [];
   <span class="keyword">for</span> i=1:size(ts.trap_level{k},2)
      cell_list = [cell_list; find(ts.trap_level{k}(:,i)&gt;0)]; <span class="comment">%#ok</span>
   <span class="keyword">end</span>
   plotGrid(Gt, cell_list, <span class="string">'FaceColor'</span>, col(k,:),  <span class="string">'EdgeAlpha'</span>,.1);
<span class="keyword">end</span>
colormap(col); cbh=colorbar(<span class="string">'horiz'</span>); caxis([0 nt]+.5);set(cbh,<span class="string">'XTick'</span>,1:nt);
view(100,70)
</pre><img vspace="5" hspace="5" src="showTrappingStructure_04.png" alt=""> <p>All the CO2 that accumulates in a trap must come from the trap's drainage area that consists of all cells that have an updip connection to the trap. We show the drainage/accumlation area of the different traps defined as the cells whose spill paths lead into the corresponding local top point. A spill path is the path that the CO2 will follow in its upward migration when injected infinitesimally slow from a given point</p><pre class="codeinput">clf, subplot(<span class="string">'position'</span>,[.025 .025 .95 .95]);

<span class="comment">% To find the drainage area, we construct a directed graph from the gravity</span>
<span class="comment">% flux, make this graph bi-directional along each edge, and then compute</span>
<span class="comment">% the connected components.</span>
C       = maxTPFAGravityMatrix(Gt);
[ci,ss] = components(C+C');  assert(max(ci)==numel(ts.top))

<span class="comment">% Set a unique random color for each trap</span>
p  = zeros(length(ts.top),1);
nt =  sum(ts.istrap);
p(ci(ts.top(ts.istrap))) = randperm(nt)';

<span class="comment">% Plot grid, drainage areas for traps, and the local top points</span>
plotGrid(Gt, <span class="string">'FaceColor'</span>,<span class="string">'none'</span>, <span class="string">'EdgeAlpha'</span>, .05)
plotCellData(Gt,p(ci), p(ci)&gt;0, <span class="string">'EdgeColor'</span>, <span class="string">'none'</span>);
plotGrid(Gt,ts.top(ts.istrap), <span class="string">'FaceColor'</span>,[.45 .45 .45],<span class="string">'EdgeAlpha'</span>,.1);
axis <span class="string">tight</span> <span class="string">off</span>, view(85,50), colormap(jet(nt));
</pre><img vspace="5" hspace="5" src="showTrappingStructure_05.png" alt=""> <h2>Find trap connections (river system)<a name="7"></a></h2><p>The CO2 is typically injected low in the formation and if we disregard all other trapping mechanisms, the CO2 will migrate upward until it encounters a structural trap. Once a trap is filled, the CO2 will spill over and start to migrate upward along a spill path and either reach the top of the formation or start to accumulate in a more shallow trap until this trap spills over, and so on. We start by computing the connections between the traps.</p><pre class="codeinput">mrstModule <span class="string">add</span> <span class="string">coarsegrid</span>

trap_con    = findTrapConnections(Gt, ts.z_spill_loc);
cell_lines  = trap_con.cell_lines;
traps       = trap_con.traps;
leaf_lines  = trap_con.leaf_lines;
leaf_traps  = trap_con.leaf_traps;
trap_matrix = trap_con.trap_matrix;
</pre><pre class="codeoutput">Start find rivers
</pre><p>If we invert the axis, the structural trapping may be thought of as water flowing down in a terrain consisting of impermeable soil. The water will collect in ponds and small lakes that are possibly connected by natural watercourses (rivers).</p><pre class="codeinput"><span class="comment">% Find connection stucture of the river network</span>
comp = components(trap_matrix+trap_matrix');
trap_comp=nan(size(traps));

<span class="comment">% Make vectors representing each independent waterway</span>
p = randperm(max(comp));  <span class="comment">% to avoid the proximity of similar colors</span>
<span class="keyword">for</span> i=1:numel(comp)
    trap_comp(i==traps)=p(comp(i));
<span class="keyword">end</span>
cc=[ts.Gtop.cells.centroids,ts.Gtop.cells.z];
[x,y,z] = deal([]);
<span class="keyword">for</span> i=1:numel(cell_lines);
   x = [x; cc(double(cell_lines{i}),1); NaN]; <span class="comment">%#ok</span>
   y = [y; cc(double(cell_lines{i}),2); NaN]; <span class="comment">%#ok</span>
   z = [z; cc(double(cell_lines{i}),3); NaN]; <span class="comment">%#ok</span>
<span class="keyword">end</span>

<span class="comment">% Plot the 'lakes' and the watercourses</span>
clf, subplot(<span class="string">'position'</span>, [.025 .025 .95 .95]);
plotCellData(ts.Gtop,trap_comp)
plotGrid(ts.Gtop,<span class="string">'FaceColor'</span>,<span class="string">'none'</span>,<span class="string">'edgeAlpha'</span>,0.1)
hold <span class="string">on</span>
plot3(x,y,z, <span class="string">'k'</span>, <span class="string">'LineWidth'</span>, 2)
hold <span class="string">off</span>
view(280,40), axis <span class="string">tight</span> <span class="string">off</span>; set(gca,<span class="string">'ZDir'</span>, <span class="string">'normal'</span>);
</pre><img vspace="5" hspace="5" src="showTrappingStructure_06.png" alt=""> <p>As our last example, we will look at leaf nodes in our trapping system, i.e., traps that only have outgoing 'rivers'. The leaf traps are shown in white color. The drainage areas and the resulting migration path are given a unique  color so that one can trace the migration of CO2 upward until it either  leaves the formation or reaches a higher trap that accumulates CO2 from multiple leaf traps. All traps that are not leaf traps are shown in dark gray.</p><pre class="codeinput"><span class="comment">% Plot traps and grid</span>
cla
plotGrid(ts.Gtop, ts.z_spill_loc&gt;0, <span class="string">'EdgeColor'</span>, <span class="string">'none'</span>, <span class="string">'FaceColor'</span>,[.25 .25 .25])
plotGrid(ts.Gtop, <span class="string">'FaceColor'</span>, <span class="string">'none'</span>, <span class="string">'EdgeAlpha'</span>, .1)

<span class="comment">% Find leaves and the corresponding traps</span>
[ll, tc, dc] = deal([]);
C    = maxTPFAGravityMatrix(ts.Gtop);
nll  = numel(leaf_lines);
p    = randperm(nll);
lvol = zeros(nll,1);
tic
<span class="keyword">for</span> k=nll:-1:1
   <span class="comment">% extract the leaf line out of the trap</span>
   ll  = [ll; leaf_lines{k}', p(k)*ones(length(leaf_lines{k}),1)]; <span class="comment">%#ok</span>

   <span class="comment">% find all cells in the given trap</span>
   t_cells = find(traps ==leaf_traps{k});
   tc = [tc; t_cells]; <span class="comment">%#ok</span>

   <span class="comment">% find all cells in the drainage region of the leaf</span>
   cc = find( dfs(C', double(t_cells(1))) &gt;0);
   dc  = [dc; cc, p(k)*ones(length(cc),1)]; <span class="comment">%#ok</span>

   <span class="comment">% calculate the leaf volume</span>
   cc = find( dfs(C, double(t_cells(1)))&gt;0 );
   lvol(k) = sum((ts.Gtop.cells.z(cc) - Gt.cells.z(cc)).*Gt.cells.volumes(cc));
   disp([<span class="string">'Leaf volume : '</span>, num2str(lvol(k))]);
<span class="keyword">end</span>

<span class="comment">% Plot leaves and the deepest traps</span>
plotCellData(ts.Gtop, [ll(:,2); dc(:,2)], [ll(:,1); dc(:,1)], <span class="string">'EdgeColor'</span>, <span class="string">'none'</span>);
plotGrid(ts.Gtop, tc, <span class="string">'EdgeColor'</span>, <span class="string">'none'</span>, <span class="string">'FaceColor'</span>, <span class="string">'w'</span>);
view(95,20), axis <span class="string">tight</span> <span class="string">off</span>; set(gca,<span class="string">'ZDir'</span>, <span class="string">'reverse'</span>);
</pre><pre class="codeoutput">Leaf volume : 618782.3458
Leaf volume : 1920205.7847
Leaf volume : 0
Leaf volume : 33295634.1306
Leaf volume : 34577258.0053
Leaf volume : 28458992.5049
Leaf volume : 136488585.5204
Leaf volume : 820247394.6633
Leaf volume : 381407666.5635
Leaf volume : 975677262.5204
Leaf volume : 812477042.3271
Leaf volume : 13273947.4493
Leaf volume : 812032999.8997
Leaf volume : 921435649.9908
Leaf volume : 849094847.046
Leaf volume : 361006825.2235
Leaf volume : 9101232.1556
Leaf volume : 509961.9253
Leaf volume : 36649535.63
Leaf volume : 15594.5838
Leaf volume : 496026164.2495
Leaf volume : 7022319093.149
Leaf volume : 1468444523.9203
Leaf volume : 99286419.5772
Leaf volume : 1469819977.0619
Leaf volume : 2572532.6835
Leaf volume : 228483848.0456
Leaf volume : 1469819977.0619
Leaf volume : 7519927861.7073
Leaf volume : 1009105.2054
Leaf volume : 18805622.7009
Leaf volume : 2621476253.2478
Leaf volume : 1686896.3595
Leaf volume : 1207744737.7059
Leaf volume : 3862613.6834
Leaf volume : 270895768.0561
Leaf volume : 1505263255.3188
Leaf volume : 1505263255.3188
Leaf volume : 582974.0581
Leaf volume : 581524995.8565
Leaf volume : 1218254059.2199
Leaf volume : 34567037.3357
Leaf volume : 1220898307.2355
Leaf volume : 581336917.8887
Leaf volume : 745338740.1382
Leaf volume : 40227970.7599
</pre><img vspace="5" hspace="5" src="showTrappingStructure_07.png" alt=""> <p class="footer"><br>
      Published with MATLAB&reg; 7.13<br></p></div><!--
##### SOURCE BEGIN #####
%% Investigation of Structural Trapping
% The purpose of the example is to demonstrate some of the functionality we
% have available for studying migration patterns and finding structural
% trapping. As an example, we consider the Utsira formation for which we
% will trace gravity lines, identify structural traps, and investigate how
% they are connected.

%% Load data
% Make top-surface grid from a coarsened version of the Utsira formation
[grdecl,m] = getAtlasGrid('Utsirafm','coarsening',3);
G    = processGRDECL(grdecl{1});
Gt   = topSurfaceGrid(G(1));
meta = m{2}.meta;
data = abs(m{2}.data)';
data(data==0) = NaN;

%% Trace gravity lines on the top surface
% To show the potential migration paths, we trace 'gravity' lines in the
% upward direction using a flux defined on a standard TPFA type connection

% Define flux
internal = all(Gt.faces.neighbors>0,2);
n1   = Gt.faces.neighbors(internal,1);
n2   = Gt.faces.neighbors(internal,2);
flux = zeros(Gt.faces.num,1);
flux(internal)= Gt.cells.z(n2) - Gt.cells.z(n1);
state = struct('flux',flux);
clear internal n1 n2 flux;

% Pick approximately five hundred cells and trace streamlines backward
% using the Pollock routine from MRST's streamlines module
mrstModule add streamlines
seeds = (1:ceil(Gt.cells.num/500):Gt.cells.num)';
S = pollock(Gt, state, [seeds, repmat([.5,.5],numel(seeds),1)], 'reverse', true);

% Make Cartesian grid for fast interpolation to surface
y = linspace(0,meta.cellsize*(meta.ncols-1),meta.ncols) + meta.yllcorner;
x = linspace(0,meta.cellsize*(meta.nrows-1),meta.nrows) + meta.xllcorner;
[X,Y] = meshgrid(x,y); clear x y;

% Collect streamlines in a long array separated by zeros and calculate the
% corresponding z-value by interpolating in the original meta data set.
% Afterwards, replace zeros by NaN's for use in plotting.
c = zeros(sum([cellfun(@length,S); numel(S)]),3);
i = 1;
for k=1:numel(S)
   nsl = length(S{k});
   c(i:i+nsl-1,1:2) = S{k};
   i = i+nsl+1;
end
c(:,3) = interp2(X,Y,data, c(:,1), c(:,2));
c(c==0)=NaN;

% Use the original meta data to surf make the surface, but offset the plots
% slightly to distinguish the surface and the gravity lines
figure(1),clf
surf(X,Y,data+1),shading interp
hold on
plot3(c(:,1),c(:,2),c(:,3)-1, 'k-', 'LineWidth', 1);
hold off
view(70,50), axis tight, set(gca,'ZDir','reverse');

%% Find trapping structure
% We find all traps corresponding to local maxima on the top surface. The
% traps are categorized as different levels. A level-1 trap contains one
% local maximum point; a level-2 trap contains at least two level-1 traps
% and hence at least one spill point; a level-3 trap contains at least two
% level-2 traps; and so on. As part of finding the trapping structure, we
% construct a new top-surface grid for which the topography inside the
% level-1 traps have been replaced by a flat surface at the depth of the
% corresponding spill point.

% Check for existence of the MATLAB graph library
checkBGL();

ts=findTrappingStructure(Gt);

% Plot the new top-surface grid on top of the old one to show the location
% of traps
clf, subplot('position',[.025 .025 .95 .95]);
plotGrid(Gt,      'FaceColor','r','EdgeAlpha',.1)
plotGrid(ts.Gtop, 'FaceColor','y','EdgeColor','none');
view(92,40), axis tight off, set(gca,'ZDir','reverse');

%%
% Show the flat parts of the grid
cla
plotGrid(ts.Gtop,'FaceColor','none','EdgeAlpha',.1)
plotGrid(ts.Gtop, ts.z_spill_loc>0, 'EdgeAlpha', .1)

%%
% Show the traps on different levels in different colors
cla
plotGrid(ts.Gtop,'FaceColor','none','edgeAlpha',0.1)
nt  = numel(ts.trap_level);
col = hsv(nt);
for k=nt:-1:1
   cell_list = [];
   for i=1:size(ts.trap_level{k},2)
      cell_list = [cell_list; find(ts.trap_level{k}(:,i)>0)]; %#ok
   end
   plotGrid(Gt, cell_list, 'FaceColor', col(k,:),  'EdgeAlpha',.1);
end
colormap(col); cbh=colorbar('horiz'); caxis([0 nt]+.5);set(cbh,'XTick',1:nt);
view(100,70)

%% 
% All the CO2 that accumulates in a trap must come from the trap's drainage
% area that consists of all cells that have an updip connection to the
% trap. We show the drainage/accumlation area of the different traps
% defined as the cells whose spill paths lead into the corresponding local
% top point. A spill path is the path that the CO2 will follow in its
% upward migration when injected infinitesimally slow from a given point
clf, subplot('position',[.025 .025 .95 .95]);

% To find the drainage area, we construct a directed graph from the gravity
% flux, make this graph bi-directional along each edge, and then compute
% the connected components.
C       = maxTPFAGravityMatrix(Gt);
[ci,ss] = components(C+C');  assert(max(ci)==numel(ts.top))

% Set a unique random color for each trap
p  = zeros(length(ts.top),1);
nt =  sum(ts.istrap);
p(ci(ts.top(ts.istrap))) = randperm(nt)';

% Plot grid, drainage areas for traps, and the local top points
plotGrid(Gt, 'FaceColor','none', 'EdgeAlpha', .05)
plotCellData(Gt,p(ci), p(ci)>0, 'EdgeColor', 'none');
plotGrid(Gt,ts.top(ts.istrap), 'FaceColor',[.45 .45 .45],'EdgeAlpha',.1);
axis tight off, view(85,50), colormap(jet(nt));


%% Find trap connections (river system)
% The CO2 is typically injected low in the formation and if we disregard
% all other trapping mechanisms, the CO2 will migrate upward until it
% encounters a structural trap. Once a trap is filled, the CO2 will spill
% over and start to migrate upward along a spill path and either reach the
% top of the formation or start to accumulate in a more shallow trap until
% this trap spills over, and so on. We start by computing the connections
% between the traps.
mrstModule add coarsegrid

trap_con    = findTrapConnections(Gt, ts.z_spill_loc);
cell_lines  = trap_con.cell_lines;
traps       = trap_con.traps;
leaf_lines  = trap_con.leaf_lines;
leaf_traps  = trap_con.leaf_traps;
trap_matrix = trap_con.trap_matrix;

%% 
% If we invert the axis, the structural trapping may be thought of as water
% flowing down in a terrain consisting of impermeable soil. The water will
% collect in ponds and small lakes that are possibly connected by natural
% watercourses (rivers). 

% Find connection stucture of the river network
comp = components(trap_matrix+trap_matrix');
trap_comp=nan(size(traps));

% Make vectors representing each independent waterway
p = randperm(max(comp));  % to avoid the proximity of similar colors 
for i=1:numel(comp)
    trap_comp(i==traps)=p(comp(i));
end
cc=[ts.Gtop.cells.centroids,ts.Gtop.cells.z];
[x,y,z] = deal([]);
for i=1:numel(cell_lines);
   x = [x; cc(double(cell_lines{i}),1); NaN]; %#ok
   y = [y; cc(double(cell_lines{i}),2); NaN]; %#ok
   z = [z; cc(double(cell_lines{i}),3); NaN]; %#ok
end

% Plot the 'lakes' and the watercourses 
clf, subplot('position', [.025 .025 .95 .95]);
plotCellData(ts.Gtop,trap_comp)
plotGrid(ts.Gtop,'FaceColor','none','edgeAlpha',0.1)
hold on
plot3(x,y,z, 'k', 'LineWidth', 2)
hold off
view(280,40), axis tight off; set(gca,'ZDir', 'normal');

%%
% As our last example, we will look at leaf nodes in our trapping system,
% i.e., traps that only have outgoing 'rivers'. The leaf traps are shown in
% white color. The drainage areas and the resulting migration path are
% given a unique  color so that one can trace the migration of CO2 upward
% until it either  leaves the formation or reaches a higher trap that
% accumulates CO2 from multiple leaf traps. All traps that are not leaf
% traps are shown in dark gray.

% Plot traps and grid
cla
plotGrid(ts.Gtop, ts.z_spill_loc>0, 'EdgeColor', 'none', 'FaceColor',[.25 .25 .25])
plotGrid(ts.Gtop, 'FaceColor', 'none', 'EdgeAlpha', .1)

% Find leaves and the corresponding traps
[ll, tc, dc] = deal([]);
C    = maxTPFAGravityMatrix(ts.Gtop);
nll  = numel(leaf_lines);
p    = randperm(nll);
lvol = zeros(nll,1);
tic
for k=nll:-1:1
   % extract the leaf line out of the trap
   ll  = [ll; leaf_lines{k}', p(k)*ones(length(leaf_lines{k}),1)]; %#ok
   
   % find all cells in the given trap
   t_cells = find(traps ==leaf_traps{k});
   tc = [tc; t_cells]; %#ok

   % find all cells in the drainage region of the leaf
   cc = find( dfs(C', double(t_cells(1))) >0);
   dc  = [dc; cc, p(k)*ones(length(cc),1)]; %#ok
   
   % calculate the leaf volume
   cc = find( dfs(C, double(t_cells(1)))>0 );
   lvol(k) = sum((ts.Gtop.cells.z(cc) - Gt.cells.z(cc)).*Gt.cells.volumes(cc));
   disp(['Leaf volume : ', num2str(lvol(k))]);
end

% Plot leaves and the deepest traps
plotCellData(ts.Gtop, [ll(:,2); dc(:,2)], [ll(:,1); dc(:,1)], 'EdgeColor', 'none');
plotGrid(ts.Gtop, tc, 'EdgeColor', 'none', 'FaceColor', 'w');
view(95,20), axis tight off; set(gca,'ZDir', 'reverse');

##### SOURCE END #####
--></body></html>